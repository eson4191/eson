name: Auto Deploy Cloudflare Worker

on:
  push:
    branches: [main]  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘éƒ¨ç½²
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°'
        required: false
        default: 'false'

permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“ï¼ˆå¦‚æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶ï¼‰

jobs:
  deploy-worker:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Wranglerï¼ˆæœ€æ–°ç‰ˆï¼‰
        run: npm install -g wrangler@3

      - name: æ£€æŸ¥å¹¶æ›´æ–° Workerï¼ˆå¯é€‰ï¼Œè‹¥éœ€è‡ªåŠ¨åŒæ­¥å…¶ä»–ä»“åº“ç‰ˆæœ¬ï¼‰
        if: github.event.inputs.force_update == 'true' || github.ref == 'refs/heads/main'
        run: |
          # è¿™é‡Œå¯ä¿ç•™åŸæœ‰ä»å…¶ä»–ä»“åº“ä¸‹è½½ worker.js çš„é€»è¾‘ï¼ˆè‹¥éœ€è¦ï¼‰
          # ä¾‹å¦‚ï¼šwget https://example.com/worker.js -O _worker.js
          echo "æ— éœ€æ›´æ–°ï¼Œç›´æ¥ä½¿ç”¨ä»“åº“å†…ç°æœ‰ _worker.js"

      - name: éƒ¨ç½²åˆ° Cloudflare Workers
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}  # Cloudflare è´¦æˆ· ID
          CLOUDFLARE_WORKER_TOKEN: ${{ secrets.CLOUDFLARE_WORKER_TOKEN }}  # éƒ¨ç½²ä»¤ç‰Œ
        run: |
          cd "$GITHUB_WORKSPACE"  # è¿›å…¥ä»“åº“æ ¹ç›®å½•
          wrangler publish  # è‡ªåŠ¨è¯»å– wrangler.toml å¹¶éƒ¨ç½² Worker
          echo "éƒ¨ç½²æˆåŠŸï¼Worker ç‰ˆæœ¬ï¼š$(cat version.txt || 'æœªçŸ¥')"

      - name: æäº¤ç‰ˆæœ¬æ›´æ–°ï¼ˆå¯é€‰ï¼‰
        if: success()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨éƒ¨ç½² Worker ç‰ˆæœ¬: $(cat version.txt || 'æœªçŸ¥')"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
